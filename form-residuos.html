<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Formulario Agua</title>
<style>
body { font-family: Arial; padding:20px; max-width:600px; margin:auto; }
input, textarea { width:100%; padding:8px; margin:8px 0; }
button { padding:10px; cursor:pointer; }
</style>
</head>
<body>

<h2>Formulario ‚Äî Agua</h2>
<p>Rellene los datos solicitados:</p>

<label>Poblaci√≥n abastecida:</label>
<input name="poblacion" placeholder="habitantes">

<label>Longitud de red:</label>
<input name="longitud" placeholder="metros">

<label>Observaciones:</label>
<textarea name="obs"></textarea>

<button onclick="guardar()">üíæ Guardar datos</button>
<label>Adjuntar archivo (planos, fotos, PDF):</label>
<input type="file" id="fileInput">

<button onclick="guardarArchivo()">üìé Guardar archivo</button>

<ul id="fileList"></ul>

<button onclick="location.href='menu.html'">‚¨ÖÔ∏è Volver</button>

<script>
if(!sessionStorage.getItem('usuario')) location.href="index.html";

// ‚úÖ Guardar datos
function guardar() {
    const usuario = sessionStorage.getItem('usuario');
    const modulo = window.location.pathname.split('/').pop().replace('.html','');
    const datos = {};
    document.querySelectorAll("input, textarea").forEach(el => datos[el.name] = el.value);

    localStorage.setItem(usuario + "_" + modulo, JSON.stringify(datos));
    marcarCompleto(modulo);
    alert("‚úÖ Datos guardados");
}

function marcarCompleto(modulo) {
    let e = JSON.parse(localStorage.getItem("estado_" + sessionStorage.getItem('usuario'))) || {};
    e[modulo] = "completo";
    localStorage.setItem("estado_" + sessionStorage.getItem('usuario'), JSON.stringify(e));
}
// ‚úÖ guardar archivo en localStorage en base64
function guardarArchivo() {
    const usuario = sessionStorage.getItem('usuario');
    const modulo = window.location.pathname.split('/').pop().replace('.html','');
    const input = document.getElementById('fileInput').files[0];

    if (!input) return alert("Seleccione un archivo");

    const reader = new FileReader();
    reader.onload = function() {
        let archivos = JSON.parse(localStorage.getItem(usuario + "_" + modulo + "_files")) || [];
        archivos.push({ nombre: input.name, datos: reader.result });
        localStorage.setItem(usuario + "_" + modulo + "_files", JSON.stringify(archivos));
        alert("‚úÖ Archivo guardado");
        mostrarArchivos();
    };
    reader.readAsDataURL(input);
}

// ‚úÖ mostrar archivos
function mostrarArchivos() {
    const usuario = sessionStorage.getItem('usuario');
    const modulo = window.location.pathname.split('/').pop().replace('.html','');
    const archivos = JSON.parse(localStorage.getItem(usuario + "_" + modulo + "_files")) || [];
    const lista = document.getElementById("fileList");

    lista.innerHTML = "";
    archivos.forEach((f, i) => {
        const li = document.createElement("li");
        li.innerHTML = `${f.nombre} 
            <button onclick="descargarArchivo(${i})">‚¨áÔ∏è</button>`;
        lista.appendChild(li);
    });
}

// ‚úÖ descargar archivo
function descargarArchivo(i) {
    const usuario = sessionStorage.getItem('usuario');
    const modulo = window.location.pathname.split('/').pop().replace('.html','');
    const archivos = JSON.parse(localStorage.getItem(usuario + "_" + modulo + "_files"));
    const f = archivos[i];

    const a = document.createElement("a");
    a.href = f.datos;
    a.download = f.nombre;
    a.click();
}

mostrarArchivos();


</script>

</body>
</html>
