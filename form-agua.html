<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario Agua</title>
<style>
body { font-family: Arial; padding: 20px; background: #f2f2f2; }
.container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1);}
input, button { width: 100%; padding: 8px; margin: 5px 0; }
button { cursor: pointer; }
.file-list { margin: 10px 0; }
.file-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
.file-item span { flex: 1; }
.file-item button { background: red; color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; }
#mensaje { margin-top: 10px; font-weight: bold; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="container">
  <h2>Formulario Agua</h2>
  <p>Municipio: <span id="usuario"></span></p>

  <div id="depositos"></div>

  <input type="file" id="adjuntar" multiple>
  <div class="file-list" id="fileList"></div>

  <button id="firmarBtn">Firmar y enviar</button>
  <div id="mensaje"></div>
</div>

<script>
// Evitar acceso sin login
const usuario = localStorage.getItem("usuarioActual");
if(!usuario) window.location.href = "login.html";
document.getElementById("usuario").textContent = usuario;

// JSON de ejemplo de depósitos
const depositosData = [
  {nombre: "Depósito Central"},
  {nombre: "Depósito Norte"},
  {nombre: "Depósito Sur"}
];

// Generar formulario dinámicamente
const depositosDiv = document.getElementById("depositos");
depositosData.forEach((dep,i)=>{
  const div = document.createElement("div");
  div.innerHTML = `
    <label>${dep.nombre} - Última limpieza:</label>
    <input type="date" id="fecha_${i}">
  `;
  depositosDiv.appendChild(div);
});

// Archivos adjuntos
let archivos = [];
const adjuntarInput = document.getElementById("adjuntar");
const fileListDiv = document.getElementById("fileList");

adjuntarInput.addEventListener("change", (e)=>{
  for(const f of e.target.files){
    archivos.push(f);
  }
  mostrarArchivos();
});

function mostrarArchivos(){
  fileListDiv.innerHTML = "";
  archivos.forEach((f,i)=>{
    const div = document.createElement("div");
    div.className = "file-item";
    div.innerHTML = `<span>${f.name}</span><button onclick="quitarArchivo(${i})">X</button>`;
    fileListDiv.appendChild(div);
  });
}

function quitarArchivo(index){
  archivos.splice(index,1);
  mostrarArchivos();
}

// Configuración Google Drive Web App
const URL_DRIVE = "https://script.google.com/macros/s/AKfycbwRZ4qYYIwZZbrZIlmdaCE7vjxqDmKum28oQsq4fjdb4af5Q6Upv6lBQB0sc5KxIdW-0w/exec"; // reemplazar con la URL de tu Apps Script

// Configuración Google Forms (solo nombres y fechas)
const URL_FORM = "https://docs.google.com/forms/d/e/1FAIpQLSc84PLY4O2wM9ek3v6L14DzZ8jcqDtFeKOK01i38s7ttPt0Ng/viewform?usp=header";
const FORM_ENTRIES = {
  municipio: "entry.960913048", // cambiar a entry correcto
  depositos: depositosData.map((d,i)=>`entry.312379068${i}`),
  archivos: "entry.1907656835"
};

// Función generar PDF
function generarPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const fechaEnvio = new Date().toLocaleString();
  doc.setFontSize(16);
  doc.text("Resguardo Formulario EIEL", 10, 10);
  doc.setFontSize(12);
  doc.text(`Fecha: ${fechaEnvio}`, 10, 20);
  doc.text(`Municipio: ${usuario}`, 10, 30);
  let y=40;
  doc.text("Depósitos y última limpieza:",10,y);
  y+=10;
  depositosData.forEach((d,i)=>{
    const val = document.getElementById(`fecha_${i}`).value || "No registrada";
    doc.text(`${d.nombre}: ${val}`,15,y);
    y+=10;
  });
  if(archivos.length>0){
    doc.text("Archivos adjuntos:",10,y);
    y+=10;
    archivos.forEach(f=>{doc.text(f.name,15,y); y+=10;});
  }
  doc.save(`resguardo_${usuario}_${Date.now()}.pdf`);
}

// Botón firmar y enviar
document.getElementById("firmarBtn").addEventListener("click", async()=>{
  document.getElementById("mensaje").textContent = "";

  // 1️⃣ Subir archivos a Drive
  if(archivos.length>0){
    const fd = new FormData();
    archivos.forEach((f,i)=>fd.append("file"+i,f));
    try{
      await fetch(URL_DRIVE,{method:"POST", body: fd});
    }catch(err){
      console.error(err);
      document.getElementById("mensaje").textContent="Error subiendo archivos a Drive";
      return;
    }
  }

  // 2️⃣ Generar PDF local
  generarPDF();

  // 3️⃣ Enviar datos resumidos a Google Forms
  const fdForm = new FormData();
  fdForm.append(FORM_ENTRIES.municipio, usuario);
  depositosData.forEach((d,i)=>{
    const val = document.getElementById(`fecha_${i}`).value || "";
    fdForm.append(FORM_ENTRIES.depositos[i], val);
  });
  const nombresArchivos = archivos.map(f=>f.name).join(", ");
  fdForm.append(FORM_ENTRIES.archivos,nombresArchivos);

  try{
    await fetch(URL_FORM,{method:"POST", mode:"no-cors", body:fdForm});
  }catch(err){console.warn("No se pudo enviar a Forms, pero PDF y Drive OK");}

  archivos = [];
  mostrarArchivos();
  document.getElementById("mensaje").textContent="Formulario firmado y enviado correctamente";
});
</script>

</body>
</html>
